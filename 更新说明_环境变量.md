# Wispbyte 部署脚本更新 - 环境变量配置

## 📌 快速说明

**任务**: 修改 `wispbyte-argo-singbox-deploy.sh`，从环境变量读取配置（不再读取 config.json）

**版本**: 1.0.0 → 1.1.0

**状态**: ✅ 完成 - 所有测试通过 (24/24)

---

## 🔄 主要变化

### 1. 配置读取方式改变

**之前 (v1.0.0)**:
```bash
# 直接读取 config.json
load_config() {
    CF_DOMAIN=$(grep ... "$CONFIG_FILE" ...)
    CF_TOKEN=$(grep ... "$CONFIG_FILE" ...)
    UUID=$(grep ... "$CONFIG_FILE" ...)
    PORT=$(grep ... "$CONFIG_FILE" ...)
}
```

**现在 (v1.1.0)**:
```bash
# 从环境变量读取（由 start.sh 导出）
CF_DOMAIN="${CF_DOMAIN:-}"
CF_TOKEN="${CF_TOKEN:-}"
UUID="${UUID:-}"
PORT="${PORT:-27039}"
```

### 2. 新增配置验证

```bash
validate_config() {
    # 检查 UUID 是否设置（必填）
    if [[ -z "$UUID" ]]; then
        log "[ERROR] UUID not set (required)"
        return 1
    fi
    log "[OK] Configuration valid"
}
```

---

## 🏗️ 工作流程

```
┌─────────────────────────────────────┐
│ start.sh                            │
│ 1. 读取 config.json                 │
│ 2. 提取配置参数                      │
│ 3. 导出环境变量                      │
│    export CF_DOMAIN CF_TOKEN UUID PORT
└────────────┬────────────────────────┘
             │
             ▼
┌─────────────────────────────────────┐
│ wispbyte-argo-singbox-deploy.sh    │
│ 1. 从环境变量读取配置                │
│ 2. 验证配置 (UUID 必须存在)          │
│ 3. 下载 sing-box                    │
│ 4. 启动 sing-box (127.0.0.1:PORT)   │
│ 5. 下载 cloudflared                 │
│ 6. 启动 cloudflared 隧道            │
│ 7. 生成订阅文件                      │
└─────────────────────────────────────┘
```

---

## 📝 环境变量说明

| 变量名 | 必填 | 默认值 | 说明 |
|--------|------|--------|------|
| `UUID` | ✅ 是 | 无 | VMess UUID（必须设置） |
| `PORT` | ❌ 否 | `27039` | Sing-box 监听端口 |
| `CF_DOMAIN` | ❌ 否 | 无 | Cloudflare 固定域名（可选） |
| `CF_TOKEN` | ❌ 否 | 无 | Cloudflare 隧道令牌（可选） |

### 变量来源

所有变量由 `start.sh` 从 `/home/container/config.json` 读取后导出。

---

## ✅ 测试结果

```bash
$ ./test-wispbyte-env-vars.sh

==========================================
Test: Wispbyte Environment Variable Reading
==========================================

✓ PASS: Script syntax valid
✓ PASS: Line count < 200 (183 lines)
✓ PASS: Version 1.1.0 present
✓ PASS: CONFIG_FILE variable removed
✓ PASS: CF_DOMAIN from env
✓ PASS: CF_TOKEN from env
✓ PASS: UUID from env
✓ PASS: PORT from env with default
✓ PASS: validate_config function exists
✓ PASS: load_config function removed
✓ PASS: main() calls validate_config
✓ PASS: Function detect_arch exists
✓ PASS: Function download_singbox exists
✓ PASS: Function download_cloudflared exists
✓ PASS: Function generate_singbox_config exists
✓ PASS: Function start_singbox exists
✓ PASS: Function start_cloudflared exists
✓ PASS: Function generate_subscription exists
✓ PASS: ARM64 support present
✓ PASS: Subscription path correct
✓ PASS: VMESS v2 format
✓ PASS: TLS enabled
✓ PASS: Chrome fingerprint
✓ PASS: Config validation with env vars

==========================================
Test Summary
==========================================
Passed: 24
Failed: 0
==========================================
✅ All tests passed!
```

---

## 📋 使用示例

### 场景 1: 正常使用（由 start.sh 调用）

```bash
# start.sh 会自动处理
bash start.sh

# 内部流程：
# 1. start.sh 读取 config.json
# 2. start.sh 导出环境变量
# 3. start.sh 调用 wispbyte-argo-singbox-deploy.sh
# 4. 部署脚本从环境变量读取配置
```

### 场景 2: 手动测试

```bash
# 手动设置环境变量
export CF_DOMAIN="test.example.com"
export CF_TOKEN="test-token-123"
export UUID="12345678-1234-1234-1234-123456789abc"
export PORT="27039"

# 运行部署脚本
bash wispbyte-argo-singbox-deploy.sh
```

### 场景 3: 临时隧道（无固定域名）

```bash
# 只需要 UUID
export UUID="12345678-1234-1234-1234-123456789abc"
# 不设置 CF_DOMAIN 和 CF_TOKEN

bash wispbyte-argo-singbox-deploy.sh

# 输出：
# [INFO] Temporary tunnel (trycloudflare)
# [URL] https://random-abc.trycloudflare.com/sub
```

---

## 🔧 常见问题

### 问题 1: "UUID not set (required)"

**原因**: 环境变量 UUID 未设置

**解决**:
```bash
# 检查 config.json
cat /home/container/config.json | grep uuid

# 检查环境变量
echo $UUID

# 手动设置（测试用）
export UUID="你的UUID"
```

### 问题 2: sing-box 启动失败

**原因**: UUID 格式错误

**解决**: UUID 必须是标准 v4 格式
```
正确格式: 12345678-1234-1234-1234-123456789abc
          ^^^^^^^^-^^^^-^^^^-^^^^-^^^^^^^^^^^^
           8位    4位  4位  4位    12位
```

生成新 UUID:
```bash
uuidgen
# 或
cat /proc/sys/kernel/random/uuid
```

### 问题 3: cloudflared 启动失败

**原因**: CF_TOKEN 或 CF_DOMAIN 错误

**解决**:
1. 验证令牌是否正确（从 Cloudflare 控制台获取）
2. 检查域名是否匹配隧道配置
3. 先尝试临时隧道测试（不设置 CF_DOMAIN/CF_TOKEN）

---

## 📊 对比总结

### 代码变化

| 项目 | v1.0.0 | v1.1.0 | 变化 |
|------|--------|--------|------|
| 行数 | 181 | 183 | +2 |
| 配置来源 | config.json | 环境变量 | ✅ 改进 |
| 函数数量 | 10 | 10 | 不变 |
| 依赖 | 文件系统 | 环境变量 | ✅ 简化 |

### 功能对比

| 功能 | v1.0.0 | v1.1.0 |
|------|--------|--------|
| ARM64 支持 | ✅ | ✅ |
| VMESS-WS | ✅ | ✅ |
| 固定域名 | ✅ | ✅ |
| 临时隧道 | ✅ | ✅ |
| 订阅生成 | ✅ | ✅ |
| 配置验证 | 隐式 | 显式 ✅ |

---

## 🎯 优势

1. **职责分离**
   - start.sh: 负责读取配置文件
   - deploy 脚本: 只负责部署任务
   
2. **避免重复读取**
   - 配置只读取一次（start.sh）
   - 通过环境变量传递给子进程
   
3. **更易测试**
   - 只需设置环境变量即可测试
   - 无需创建 config.json 文件
   
4. **保持兼容**
   - 所有功能保持不变
   - 输出格式相同
   - 文件位置相同

---

## ✅ 完成清单

- ✅ 移除 CONFIG_FILE 变量
- ✅ 移除 load_config() 函数
- ✅ 添加环境变量读取
- ✅ 添加 validate_config() 函数
- ✅ 更新版本号到 1.1.0
- ✅ 保持行数 < 200（实际 183 行）
- ✅ 保持所有功能不变
- ✅ 通过所有测试 (24/24)
- ✅ 创建测试脚本
- ✅ 创建文档

---

## 📁 文件清单

| 文件 | 状态 | 说明 |
|------|------|------|
| `wispbyte-argo-singbox-deploy.sh` | ✅ 已修改 | 主部署脚本（v1.1.0） |
| `start.sh` | ✅ 无需修改 | 已导出环境变量 |
| `test-wispbyte-env-vars.sh` | ✅ 新增 | 测试脚本（24个测试） |
| `WISPBYTE_ENV_VARS_UPDATE.md` | ✅ 新增 | 详细文档（英文） |
| `更新说明_环境变量.md` | ✅ 新增 | 快速说明（中文） |

---

## 🚀 部署

**分支**: `fix/wispbyte-argo-singbox-read-env`

**状态**: ✅ 可以部署到生产环境

**修改的文件**: 1 个
**新增的文件**: 2 个
**测试通过率**: 100% (24/24)

---

## 📞 技术支持

如有问题，请检查：

1. **start.sh** 是否正确导出环境变量
   ```bash
   grep "export CF_DOMAIN" start.sh
   ```

2. **config.json** 是否存在且格式正确
   ```bash
   cat /home/container/config.json
   ```

3. **环境变量** 是否正确设置
   ```bash
   env | grep -E "UUID|CF_DOMAIN|CF_TOKEN|PORT"
   ```

4. **运行测试脚本**
   ```bash
   bash test-wispbyte-env-vars.sh
   ```

---

**更新日期**: 2025-01-XX  
**版本**: 1.1.0  
**状态**: ✅ 完成
